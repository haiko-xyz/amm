# Modify position

## Case 1 (MPALU): Add liquidity at previously uninitialised limits

1. Initial market config checks: [35000]
2. Read state: [56000]
3. Input checks: [0]
4. Update liquidity: [3841330][T]
   1. Read state: [20000]
   2. Update lower limit: [1771120][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [1731120]
      4. Calc and set fee factors: [0]
   3. Update upper limit: [1123200][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [1083200]
      4. Calc and set fee factors: [0]
   4. Initialise position: [36450]
   5. Calc fees: [0]
   6. Update position: [20000]
   7. Calculate token amounts: [870560]
5. Update fees: [0]
6. Update reserves: [40000]
7. Transfer tokens: [1065940]
8. Emit event: [1000]

Total: [5039270]

## Case 2 (MPALI): Add liquidity at previously initialised limits

1. Initial market config checks: [35000]
2. Read state: [56000]
3. Input checks: [0]
4. Update liquidity: [1067010][T]
   1. Read state: [20000]
   2. Update lower limit: [1771120][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [1731120]
      4. Calc and set fee factors: [0]
   3. Update upper limit: [1123200][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [1083200]
      4. Calc and set fee factors: [0]
   4. Initialise position: [36450]
   5. Calc fees: [0]
   6. Update position: [20000]
   7. Calculate token amounts: [870560]
5. Update fees: [0]
6. Update reserves: [40000]
7. Transfer tokens: [1065940]
8. Emit event: [1000]

Total: [2264950]

## Case 3 (MPALIU): Add liquidity at initialised lower, but previously uninitialised upper limit

1. Initial market config checks: [35000]
2. Read state: [56000]
3. Input checks: [0]
4. Update liquidity: [2704970][T]
   1. Read state: [20000]
   2. Update lower limit: [634760][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [1083200]
      4. Calc and set fee factors: [0]
   3. Update upper limit: [1123200][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [1083200]
      4. Calc and set fee factors: [0]
   4. Initialise position: [36450]
   5. Calc fees: [0]
   6. Update position: [20000]
   7. Calculate token amounts: [875560]
5. Update fees: [0]
6. Update reserves: [40000]
7. Transfer tokens: [1065940]
8. Emit event: [1000]

Total: [3902910]

## Case 4 (MPCF): Collect fees from position (position is only one at limits)

1. Initial market config checks: [35000]35000+56000+156450+40000+1065940+1000
2. Read state: [56000]
3. Input checks: [0]
4. Update liquidity: [156450][T]
   1. Read state: [20000]
   2. Update lower limit: [40000][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [0]
      4. Calc and set fee factors: [0]
   3. Update upper limit: [40000][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [0]
      4. Calc and set fee factors: [0]
   4. Initialise position: [36450]
   5. Calc fees: [0]
   6. Update position: [20000]
   7. Calculate token amounts: [0]
5. Update fees: [20000]
6. Update reserves: [20000]
7. Transfer tokens: [1065940]
8. Emit event: [1000]

Total: [1354390]

## Case 5 (MPRL01): Remove liquidity with no accumulated fees (position is only one at limits)

1. Initial market config checks: [35000]
2. Read state: [56000]
3. Input checks: [0]
4. Update liquidity: [1294650][T]
   1. Read state: [20000]
   2. Update lower limit: [229480][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [189480]
      4. Calc and set fee factors: [0]
   3. Update upper limit: [103160][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [63160]
      4. Calc and set fee factors: [0]
   4. Initialise position: [36450]
   5. Calc fees: [0]
   6. Update position: [20000]
   7. Calculate token amounts: [850560]
5. Update fees: [0]
6. Update reserves: [20000]
7. Transfer tokens: [402390]
8. Emit event: [1000]

Total: [1809040]

## Case 6 (MPRLFM): Remove liquidity with accumulated fees (position is only one at limits)

1. Initial market config checks: [35000]
2. Read state: [56000]
3. Input checks: [0]
4. Update liquidity: [3846330][T]
   1. Read state: [20000]
   2. Update lower limit: [741080][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [701080]
      4. Calc and set fee factors: [0]
   3. Update upper limit: [2143240][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [2103240]
      4. Calc and set fee factors: [0]
   4. Initialise position: [36450]
   5. Calc fees: [0]
   6. Update position: [20000]
   7. Calculate token amounts: [850560]
5. Update fees: [0]
6. Update reserves: [20000]
7. Transfer tokens: [402390]
8. Emit event: [1000]

Total: [4360720]

## Case 7 (MPRL01): Remove liquidity with no accumulated fees (other positions exist at limits)

1. Initial market config checks: [35000]
2. Read state: [56000]
3. Input checks: [0]
4. Update liquidity: [1007010][T]
   1. Read state: [20000]
   2. Update lower limit: [40000][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [0]
      4. Calc and set fee factors: [0]
   3. Update upper limit: [40000][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [0]
      4. Calc and set fee factors: [0]
   4. Initialise position: [36450]
   5. Calc fees: [0]
   6. Update position: [20000]
   7. Calculate token amounts: [850560]
5. Update fees: [0]
6. Update reserves: [20000]
7. Transfer tokens: [402390]
8. Emit event: [1000]

Total: [1521400]

## Case 8 (MPRLFM): Remove liquidity with accumulated fees (other positions exist at limits)

1. Initial market config checks: [35000]35000+56000+1027010+20000+40000+803780+1000
2. Read state: [56000]
3. Input checks: [0]
4. Update liquidity: [1027010][T]
   1. Read state: [20000]
   2. Update lower limit: [40000][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [0]
      4. Calc and set fee factors: [0]
   3. Update upper limit: [40000][T]
      1. Update limit: [20000]
      2. Check overflow: [0]
      3. Update bitmap: [0]
      4. Calc and set fee factors: [0]
   4. Initialise position: [36450]
   5. Calc fees: [0]
   6. Update position: [20000]
   7. Calculate token amounts: [850560]
5. Update fees: [20000]
6. Update reserves: [40000]
7. Transfer tokens: [803780]
8. Emit event: [1000]

Total: [1982790]

# Swap

## Case 1: (SZL): Swap with zero liquidity

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [1000][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [4416790][T]
   1. Checks + Init state: [0]
   2. Tree next limit: [68160]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [8035090] [T]
   1. Check iterator: [0]
13. Fill partial limits: [0] [T]
14. Transfer tokens: [721700]
15. Strategy cleanup: [0]
16. Emit event: [1000]

Total: [13331580]

## Case 2: (SPHN): Swap with normal liquidity position, high liquidity, no limit crossed

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [1000][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [13798290][T]
   1. Checks + Init state: [0]
   2. Tree next limit: [111320]
   3. Calculate target price: [425280]
   4. Compute Swap Amounts: [0][T]
      1. Calculate amounts: [0]
      2. Calculate next sqrt price: [0]
      3. Update amounts: [0]
      4. Calc fee: [0]
   5. Calc amts + fees: [0]
   6. Update market state: [8913060]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [8035090] [T]
13. Fill partial limits: [0] [T]
14. Transfer tokens: [721700]
15. Strategy cleanup: [0]
16. Emit event: [1000]

Total: [22713080]

## Case 3: (SPH1): Swap with normal liquidity position, high liquidity, one limit crossed

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [1000][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [11308940][T]
   1. 1st Iteration: [1055040][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [589760]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [50000]
      8. Update mkt state: [0]
   2. 2nd Iteration: [1556640][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [1131360]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [8035090] [T]
13. Fill partial limits: [0] [T]
14. Transfer tokens: [721700]
15. Strategy cleanup: [0]
16. Emit event: [1000]

Total: [20223730]

## Case 4: (SPH4): Swap with normal liquidity position, high liquidity, four limits crossed

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [1000][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [28768240][T]
   1. 1st Iteration: [523440][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [58160]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   2. 2nd Iteration: [789240][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [323960]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   3. 3rd Iteration: [1065040][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [599760]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   4. 4th Iteration: [1340840][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [875560]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   5. 5th Iteration: [1237680][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [1237680]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [40335490] [T]
   1. 1st Iteration: [40010]
   2. 2nd Iteration: [40010]
   3. 3nd Iteration: [40010]
   4. 4nd Iteration: [40010]
13. Fill partial limits: [0] [T]
14. Transfer tokens: [721700]
15. Strategy cleanup: [0]
16. Emit event: [1000]

Total: [67914580]

## Case 5: (SPH9): Swap with normal liquidity position, high liquidity, nine limits crossed

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [1000][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [57399900][T]
   1. 1st Iteration: [523440][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [58160]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   2. 2nd Iteration: [1055040][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [589760]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   3. 3rd Iteration: [1001880][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [536600]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   4. 4th Iteration: [1214520][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [749240]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   5. 5th Iteration: [1118200][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [652920]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   6. 6th Iteration: [1001880][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [536600]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   7. 7th Iteration: [1277680][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [812400]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   8. 8th Iteration: [1055040][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [589760]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   9. 9th Iteration: [1340840][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [875560]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   10. 10th Iteration: [1237680][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [1237680]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [80710990] [T]
   1. 1st Iteration: [40010]
   2. 2nd Iteration: [40010]
   3. 3nd Iteration: [40010]
   4. 4nd Iteration: [40010]
   5. 5th Iteration: [40010]
   6. 6th Iteration: [40010]
   7. 7th Iteration: [40010]
   8. 8th Iteration: [40010]
   9. 9th Iteration: [40010]
13. Fill partial limits: [0] [T]
14. Transfer tokens: [721700]
15. Strategy cleanup: [0]
16. Emit event: [1000]

Total: [135903190]

## Case 6: (SLLFF): Swap with limit order, limit fully filled

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [1000][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [13745130][T]
   1. Checks + Init state: [0]
   2. Tree next limit: [58160]
   3. Calculate target price: [425280]
   4. Compute Swap Amounts: [0][T]
      1. Calculate amounts: [0]
      2. Calculate next sqrt price: [0]
      3. Update amounts: [0]
      4. Calc fee: [0]
   5. Calc amts + fees: [0]
   6. Update mkt state: [8913060]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [8035090] [T]
13. Fill partial limits: [0] [T]
14. Transfer tokens: [721700]
15. Strategy cleanup: [0]
16. Emit event: [1000]

Total: [22659920]

## Case 7: (SLLPF): Swap with limit order, limit partially filled

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [1000][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [19492480][T]
   1. 1st Iteration: [523440][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [58160]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Append filled limit: [0]
      7. Update limit info: [40000]
      8. Update mkt state: [0]
   2. 2nd Iteration: [789240][T]
      1. Checks + Init state: [0]
      2. Tree next limit: [323960]
      3. Calculate target price: [425280]
      4. Compute Swap Amounts: [0][T]
         1. Calculate amounts: [0]
         2. Calculate next sqrt price: [0]
         3. Update amounts: [0]
         4. Calc fee: [0]
      5. Calc amts + fees: [0]
      6. Update market state: [8913060]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [27418190] [T]
13. Fill partial limits: [0] [T]
   1. Read State: [0]
   2. Update Fill: [0]
14. Transfer tokens: [721700]
15. Strategy cleanup: [0]
16. Emit event: [1000]

Total: [48181450]

## Case 8 (SSNP): Swap with strategy enabled, no position updates

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [21088440][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [13924610][T]
   1. Checks + Init state: [0]
   2. Tree next limit: [662920]
   3. Calculate target price: [425280]
   4. Compute Swap Amounts: [0][T]
      1. Calculate amounts: [0]
      2. Calculate next sqrt price: [0]
      3. Update amounts: [0]
      4. Calc fee: [0]
   5. Calc amts + fees: [0]
   6. Update market state: [8487780]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [8035090] [T]
13. Fill partial limits: [40010] [T]
   1. Read State: [40010]
14. Transfer tokens: [721700]
15. Strategy cleanup: [61000]
16. Emit event: [1000]

Total: [44027850]

## Case 9 (SSOP): Swap with strategy enabled, one position updates

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [21939000][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [13924610][T]
   1. Checks + Init state: [0]
   2. Tree next limit: [662920]
   3. Calculate target price: [425280]
   4. Compute Swap Amounts: [0][T]
      1. Calculate amounts: [0]
      2. Calculate next sqrt price: [0]
      3. Update amounts: [0]
      4. Calc fee: [0]
   5. Calc amts + fees: [0]
   6. Update market state: [8487780]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [25000]
11. Update reserves: [40000]
12. Fill full limits: [8035090] [T]
13. Fill partial limits: [40010] [T]
   1. Read State: [40010]
14. Transfer tokens: [721700]
15. Strategy cleanup: [61000]
16. Emit event: [1000]

Total: [44878410]

## Case 10 (SSBP): Swap with strategy enabled, both position updates

1. Update swap_id: [10000]
2. Read state: [55000]
3. Run checks: [1000]
4. Update Strategy: [46250600][T]
5. Fetch fee rate: [0]
6. Init swap state: [20000]
7. Swap Iterator: [13904610][T]
   1. Checks + Init state: [0]
   2. Tree next limit: [642920]
   3. Calculate target price: [425280]
   4. Compute Swap Amounts: [0][T]
      1. Calculate amounts: [0]
      2. Calculate next sqrt price: [0]
      3. Update amounts: [0]
      4. Calc fee: [0]
   5. Calc amts + fees: [0]
   6. Update market state: [8487780]
8. Calc swap amts: [0]
9. Update fee: [20000]
10. Update market state: [20000]
11. Update reserves: [40000]
12. Fill full limits: [8035090] [T]
13. Fill partial limits: [0] [T]
14. Transfer tokens: [710700]
15. Strategy cleanup: [61000]
16. Emit event: [1000]

Total: [69119000]
